#!/bin/bash

ACTION="$1"
UNITS="${@:2}"

function get_unit_file(){
    
     PATHS=(
         /etc/systemd/system/
         /usr/lib/systemd/system/
     )

     for PATH in ${PATHS[@]} ; do
         if [ -f "${PATH}${1}" ] ; then
             echo "${PATH}${1}"
             break
         fi
     done

}

function action_start(){

    Type=`grep -oP '(?<=Type).*' $UNIT_FILE | cut -d '=' -f2-`
    ExecStart=`grep -oP '(?<=ExecStart).*' $UNIT_FILE | cut -d '=' -f2-`

    if [[ "${Type,,}" == *"forking"* ]] ; then
        eval "$ExecStart"
    else
        >&2 echo "Unknown service type $Type"
    fi

}
    

for UNIT in ${UNITS[@]}; do

    [[ $UNIT =~ '.' ]] || UNIT="$UNIT.service"

    UNIT_FILE=`get_unit_file $UNIT`

    if [ -z $UNIT_FILE ] ; then
        >&2 echo "Failed to $ACTION $UNIT: Unit $UNIT not found."
        exit 1
    else
        case "$ACTION" in
            start )     action_start $UNIT_FILE ;;
            * ) >&2 echo "Unknown operation $ACTION." ;;
        esac
    fi

done
